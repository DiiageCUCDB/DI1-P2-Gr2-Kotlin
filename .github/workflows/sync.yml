name: Sync GitHub â†” Azure DevOps

on:
  push:
    branches-ignore:
      - main
  workflow_dispatch:

jobs:
  sync_to_azure:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository with full history
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        fetch-tags: true

    - name: Exit if last commit is from Azure DevOps Bot
      run: |
        LAST_AUTHOR=$(git log -1 --pretty=format:'%an')
        if [ "$LAST_AUTHOR" = "Azure DevOps Bot" ]; then
          echo "Last commit is from Azure DevOps Bot. Skipping workflow."
          exit 0
        fi

    - name: Setup Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Add Azure DevOps remote
      env:
        AZURE_DEVOPS_TOKEN: ${{ secrets.AZURE_DEVOPS_TOKEN }}
      run: |
        git remote add azure "https://azure:$AZURE_DEVOPS_TOKEN@dev.azure.com/2028-DI1-P2-E2/2028_DI1_P2_E2/_git/Kotlin"

    - name: Fetch all remotes
      run: git fetch --all

    - name: Sync all branches except main
      run: |
        for branch in $(git for-each-ref --format='%(refname:short)' refs/heads/ | grep -v '^main$'); do
          echo "Syncing branch: $branch"

          git checkout $branch

          # Check if branch exists on Azure
          if ! git ls-remote --heads azure $branch | grep $branch; then
            echo "Branch $branch does not exist on Azure, creating..."
            git push azure HEAD:$branch
          else
            git pull --no-rebase azure $branch
            git push azure HEAD:$branch
          fi
        done
